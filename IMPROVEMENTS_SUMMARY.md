# ИТОГОВАЯ СВОДКА: ЧТО УЛУЧШИТЬ

## КРИТИЧЕСКИЕ ПРОБЛЕМЫ (блокируют качество MVP)

### 1. Race condition в `SNOOZE_EXPIRED`
**Файл:** `backend/app/api/goals.py:162-189`
**Проблема:** Два процесса могут одновременно обновить одну цель
**Решение:** SQL-решение через `CASE WHEN` вместо read-check-update
**Время:** 30 мин
**Влияние:** Data integrity

### 2. Отсутствие batch transactions
**Файл:** `backend/app/api/goals.py:256-263`
**Проблема:** Если batch из 10 целей, а 8-я упадёт — 7 уже в БД
**Решение:** Обернуть весь цикл в try-except-rollback
**Время:** 15 мин
**Влияние:** Data consistency

### 3. Нет валидации time windows
**Файл:** `backend/app/api/goals.py` (отсутствует)
**Проблема:** Можно установить `active_window_start=21:00, end=09:00`
**Решение:** Функция `validate_time_windows()` перед save
**Время:** 20 мин
**Влияние:** Spec compliance

---

## АРХИТЕКТУРНЫЕ УЛУЧШЕНИЯ (нужны для расширяемости)

### 4. Разделить goals.py на слои (HIGH PRIORITY)
**Файл:** `backend/app/api/goals.py` (473 строки)
**Проблема:** Все в одном файле — сложно тестировать и переиспользовать
**Решение:** 
```
goals.py (100 строк) → только route handlers
domain/goal_service.py → бизнес-логика (create, complete, snooze)
domain/goal_repository.py → доступ к БД
models/goal.py → DTO
```
**Время:** 2-3 часа
**Влияние:** Тестируемость, переиспользование в Telegram (этап 4)

### 5. Добавить GoalRepository pattern
**Проблема:** SQL прямо в handler'ах — сложно менять реализацию
**Решение:** Абстрактный слой repo для всех операций с БД
**Время:** 1 час
**Влияние:** Maintainability

---

## ТЕСТИРОВАНИЕ (medium priority, но important)

### 6. Добавить unit-тесты для goal_service
**Файл:** `backend/tests/unit/test_goal_service.py`
**Что тестировать:**
- create_goal с валидацией
- snooze_expired transition
- move_to_tomorrow изменяет дату
- complete запрещает на canceled
**Время:** 2 часа
**Влияние:** Confidence в изменениях

---

## НАБЛЮДАЕМОСТЬ (low priority, но useful)

### 7. Добавить логирование в goal_service
**Проблема:** Сложно отладить production issues
**Решение:** logger.info() при key действиях (create, complete, snooze)
**Время:** 30 мин
**Влияние:** Debuggability

---

## МИГРАЦИИ БД (medium priority)

### 8. Добавить Alembic для миграций
**Проблема:** init_db пересоздаёт БД, теряется data
**Решение:** Версионированные миграции SQL
**Время:** 1 час (первый раз)
**Влияние:** Production stability

---

## РЕКОМЕНДУЕМЫЙ ПЛАН УЛУЧШЕНИЙ

**Сразу (до этапа 3):**
1. Добавить batch transactions (15 мин)
2. Добавить валидацию time windows (20 мин)
3. Разделить goals.py на слои (2-3 часа)
4. Добавить базовые unit-тесты (2 часа)

**Параллельно с этапом 3:**
- Добавить логирование (30 мин)
- Миграции (1 час)
- Дополнительные индексы (15 мин)

**Итого критических:** ~1 часа
**Итого важных:** ~5-6 часов

**Вывод:** Стоит потратить 3-4 часа на архитектурный рефакторинг goals.py перед этапом 3, чтобы:
- Код был переиспользуемым для Telegram (этап 4)
- Было легче добавлять новые функции
- Было что тестировать
